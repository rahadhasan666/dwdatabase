<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DARK WORLD // QUANTUM TERMINAL</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { 
            --neon: #00ff00; 
            --dark-bg: #020802;
            --glass: rgba(0, 20, 0, 0.9);
            --blue-tick: #00d2ff;
            --stamp: #ff0040;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Share Tech Mono', monospace; }
        
        body { 
            background: var(--dark-bg); 
            color: var(--neon); 
            overflow-x: hidden;
            background-image: radial-gradient(circle at center, #0a2a0a 0%, #020802 100%);
        }

        #matrix-canvas { position: fixed; top: 0; left: 0; z-index: -1; opacity: 0.15; }

        .app-container {
            width: 95%; max-width: 900px; margin: 40px auto;
            background: var(--glass);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 15px; padding: 30px;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.1);
            backdrop-filter: blur(15px);
            position: relative;
        }

        .header-title {
            font-size: 2.2rem; text-align: center; margin-bottom: 30px;
            text-transform: uppercase; letter-spacing: 8px;
            background: linear-gradient(to bottom, #fff, var(--neon));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px var(--neon));
        }

        .tab-panel { display: flex; gap: 10px; margin-bottom: 30px; background: rgba(0,0,0,0.4); padding: 5px; border-radius: 8px; }
        .tab-btn { 
            flex: 1; padding: 15px; border: none; background: transparent; 
            color: var(--neon); cursor: pointer; border-radius: 5px;
            font-weight: bold; text-transform: uppercase; transition: 0.3s;
        }
        .tab-btn.active { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }

        .section { display: none; }
        .section.active { display: block; animation: slideUp 0.6s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .grid-layout { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .input-box { position: relative; }
        label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 8px; }
        input, select, textarea { 
            width: 100%; background: rgba(0,0,0,0.6); border: 1px solid #004400; 
            color: var(--neon); padding: 12px; border-radius: 5px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--neon); box-shadow: 0 0 10px rgba(0,255,0,0.2); }

        .upload-section { display: flex; gap: 20px; margin-bottom: 30px; }
        .upload-card {
            flex: 1; height: 140px; border: 1px dashed #006600; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative; background: rgba(0,0,0,0.3);
        }
        .upload-card img { position: absolute; width: 100%; height: 100%; object-fit: contain; border-radius: 10px; display: none; }

        .btn-pro {
            width: 100%; padding: 20px; margin-top: 30px;
            background: transparent; border: 1px solid var(--neon); color: var(--neon);
            font-size: 1.1rem; font-weight: bold; text-transform: uppercase; cursor: pointer;
            border-radius: 8px; transition: 0.3s; letter-spacing: 3px;
        }
        .btn-pro:hover { background: var(--neon); color: #000; box-shadow: 0 0 30px var(--neon); }

        /* Verify Result Card */
        #verify-result { 
            margin-top: 30px; padding: 25px; border-radius: 10px;
            background: rgba(0, 30, 0, 0.4); border: 1px solid var(--neon); display: none;
        }
        .verify-header { display: flex; gap: 20px; align-items: center; border-bottom: 1px solid #004400; padding-bottom: 20px; margin-bottom: 20px; }
        .verify-photo { width: 120px; height: 150px; border: 2px solid var(--neon); border-radius: 5px; }

        /* Export Card Styling (Hidden) */
        #png-card {
            position: fixed; left: -5000px; width: 600px; height: 350px;
            background: #000; border: 4px solid #0f0; padding: 25px; color: #0f0;
        }
        .stamp-box {
            position: absolute; right: 25px; bottom: 120px;
            border: 3px solid var(--stamp); color: var(--stamp);
            padding: 5px 10px; transform: rotate(-12deg); font-weight: bold;
            font-size: 14px; text-transform: uppercase;
        }
        .qr-holder {
            position: absolute; bottom: 25px; right: 25px;
            width: 85px; height: 85px; background: #fff; padding: 5px; border-radius: 3px;
        }
    </style>
</head>
<body>

    <canvas id="matrix-canvas"></canvas>

    <div id="png-card">
        <h2 style="text-align:center; border-bottom:1.5px solid #0f0; padding-bottom:10px; letter-spacing:2px;">DARK WORLD // OFFICIAL ASSET</h2>
        <div style="display:flex; margin-top:25px; gap:25px;">
            <img id="ex-pic" src="" style="width:140px; height:170px; border:1px solid #0f0; object-fit: cover;">
            <div style="font-size: 17px; line-height: 1.8;">
                <div id="ex-id"></div>
                <div id="ex-name"></div>
                <div id="ex-email"></div>
                <div id="ex-rank"></div>
                <div id="ex-phone"></div>
            </div>
        </div>
        <div class="stamp-box">ENCRYPTED<br>VERIFIED</div>
        <div class="qr-holder"><img id="ex-qr" src="" style="width:100%; height:100%;"></div>
        <div style="position:absolute; bottom:25px; left:25px; font-size:10px; opacity:0.6;">SCAN QR TO VALIDATE CLEARANCE</div>
    </div>

    <div class="app-container">
        <h1 class="header-title">Quantum Access Portal</h1>

        <div class="tab-panel">
            <button class="tab-btn active" id="tab-reg" onclick="switchTab('register')">Agent Enrollment</button>
            <button class="tab-btn" id="tab-ver" onclick="switchTab('verify')">Verification DB</button>
        </div>

        <div id="register" class="section active">
            <form id="regForm">
                <div class="upload-section">
                    <div class="upload-card" onclick="document.getElementById('file-u').click()">
                        <i class="fas fa-user-shield fa-2x"></i><span>PHOTO</span>
                        <img id="prev-u"><input type="file" id="file-u" style="display:none" required>
                    </div>
                    <div class="upload-card" onclick="document.getElementById('file-n').click()">
                        <i class="fas fa-file-invoice fa-2x"></i><span>NID (DOCS)</span>
                        <img id="prev-n"><input type="file" id="file-n" style="display:none" required>
                    </div>
                </div>

                <div class="grid-layout">
                    <div class="input-box"><label>NAME</label><input type="text" id="name" required></div>
                    <div class="input-box"><label>EMAIL</label><input type="email" id="email" required></div>
                    <div class="input-box"><label>PHONE</label><input type="number" id="phone" required></div>
                    <div class="input-box"><label>PASSWORD</label><input type="password" id="pass" required></div>
                    <div class="input-box"><label>DOB</label><input type="date" id="dob" required></div>
                    <div class="input-box"><label>RANK</label>
                        <select id="level">
                            <option value="New Recruit">New Recruit</option>
                            <option value="Shadow Agent">Shadow Agent</option>
                            <option value="Elite Pro">Elite Pro</option>
                        </select>
                    </div>
                    <div class="input-box" style="grid-column: 1/-1;"><label>FAMILY DETAILS</label><textarea id="family" rows="2" required></textarea></div>
                    <div class="input-box" style="grid-column: 1/-1;"><label>ADDRESS</label><textarea id="addr" rows="2" required></textarea></div>
                </div>
                <button type="submit" class="btn-pro">EXECUTE ENROLLMENT</button>
            </form>
        </div>

        <div id="verify" class="section">
            <div style="text-align: center; max-width: 400px; margin: 0 auto;">
                <input type="text" id="v-search" placeholder="DW-XXXXX" style="text-align: center; font-size: 1.5rem; letter-spacing: 5px;">
                <button onclick="searchAgent()" class="btn-pro">SCAN SYSTEM</button>
            </div>
            <div id="verify-result"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyASc6zbNLzENoIAnQ-fArHlqlFUoz12LJI",
            authDomain: "dark-databse.firebaseapp.com",
            projectId: "dark-databse",
            storageBucket: "dark-databse.firebasestorage.app",
            messagingSenderId: "493320117496",
            appId: "1:493320117496:web:ebdb1b1bcf44fd51c2af0d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Matrix Rain
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        const drops = Array.from({length: canvas.width/18}).fill(1);
        function drawMatrix() {
            ctx.fillStyle = "rgba(0,0,0,0.05)"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = "#0F0"; ctx.font = "18px Share Tech Mono";
            drops.forEach((y, i) => {
                const text = alphabet[Math.floor(Math.random()*alphabet.length)];
                ctx.fillText(text, i*18, y*18);
                if(y*18 > canvas.height && Math.random() > 0.975) drops[i] = 0;
                drops[i]++;
            });
        }
        setInterval(drawMatrix, 50);

        let userBase64 = "", nidBase64 = "";
        const compress = (file, callback) => {
            const r = new FileReader();
            r.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const cv = document.createElement('canvas');
                    const MAX = 400; let w = img.width, h = img.height;
                    if(w > h) { if(w > MAX) { h *= MAX/w; w = MAX; } } else { if(h > MAX) { w *= MAX/h; h = MAX; } }
                    cv.width = w; cv.height = h;
                    cv.getContext('2d').drawImage(img, 0,0,w,h);
                    callback(cv.toDataURL('image/jpeg', 0.8));
                };
                img.src = e.target.result;
            };
            r.readAsDataURL(file);
        };

        document.getElementById('file-u').onchange = (e) => compress(e.target.files[0], (res) => { userBase64 = res; document.getElementById('prev-u').src = res; document.getElementById('prev-u').style.display='block'; });
        document.getElementById('file-n').onchange = (e) => compress(e.target.files[0], (res) => { nidBase64 = res; document.getElementById('prev-n').src = res; document.getElementById('prev-n').style.display='block'; });

        // Dual Download Logic with QR Code
        async function advancedDownload(data) {
            // QR Generation
            const qrPayload = `DARK WORLD AGENT\nID: ${data.dwID}\nNAME: ${data.name}\nRANK: ${data.level}\nEMAIL: ${data.email}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrPayload)}`;

            // Populate PNG
            document.getElementById('ex-pic').src = data.photo;
            document.getElementById('ex-qr').src = qrUrl;
            document.getElementById('ex-id').innerText = "AGENT ID: " + data.dwID;
            document.getElementById('ex-name').innerText = "NAME: " + data.name;
            document.getElementById('ex-email').innerText = "EMAIL: " + data.email;
            document.getElementById('ex-rank').innerText = "RANK: " + data.level;
            document.getElementById('ex-phone').innerText = "PH: " + data.phone;

            // Wait for QR to load
            await new Promise(resolve => document.getElementById('ex-qr').onload = resolve);

            // Export PNG
            const pngWrap = document.getElementById('png-card');
            const canvasObj = await html2canvas(pngWrap, { useCORS: true });
            const pngLink = document.createElement('a');
            pngLink.download = `${data.dwID}_ID.png`;
            pngLink.href = canvasObj.toDataURL();
            pngLink.click();

            // Export PDF after delay
            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', [160, 100]);
                pdf.setFillColor(0,0,0); pdf.rect(0,0,160,100,'F');
                pdf.setDrawColor(0,255,0); pdf.rect(5,5,150,90);
                pdf.setTextColor(0,255,0);
                pdf.setFontSize(14); pdf.text("DARK WORLD ELITE PASS", 80, 15, {align:'center'});
                pdf.addImage(data.photo, 'JPEG', 10, 25, 40, 50);
                pdf.setFontSize(10);
                pdf.text(`ID: ${data.dwID}`, 55, 35);
                pdf.text(`NAME: ${data.name}`, 55, 45);
                pdf.text(`RANK: ${data.level}`, 55, 55);
                pdf.text(`EMAIL: ${data.email}`, 55, 65);
                // Add QR and Stamp to PDF
                pdf.addImage(qrUrl, 'PNG', 125, 65, 25, 25);
                pdf.setDrawColor(255, 0, 60); pdf.setTextColor(255, 0, 60);
                pdf.rect(120, 45, 30, 15);
                pdf.text("VERIFIED", 135, 54, {align:'center'});
                pdf.save(`${data.dwID}_PASSPORT.pdf`);
            }, 2500);
        }

        document.getElementById('regForm').onsubmit = async (e) => {
            e.preventDefault();
            const dwID = "DW" + Math.floor(10000 + Math.random() * 90000);
            try {
                const cred = await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value);
                await sendEmailVerification(cred.user);
                const d = {
                    uid: cred.user.uid, dwID, email: document.getElementById('email').value,
                    name: document.getElementById('name').value, phone: document.getElementById('phone').value,
                    level: document.getElementById('level').value, photo: userBase64, nid: nidBase64,
                    family: document.getElementById('family').value, dob: document.getElementById('dob').value,
                    addr: document.getElementById('addr').value
                };
                await setDoc(doc(db, "agents", cred.user.uid), d);
                await advancedDownload(d);
                alert("ENROLLED! SYSTEM GENERATING ASSETS...");
                location.reload();
            } catch (err) { alert(err.message); }
        };

        window.searchAgent = async () => {
            const id = document.getElementById('v-search').value.toUpperCase();
            const res = document.getElementById('verify-result');
            res.innerHTML = "INTERROGATING DATABASE..."; res.style.display = "block";
            const q = query(collection(db, "agents"), where("dwID", "==", id));
            const snap = await getDocs(q);
            if(snap.empty) { res.innerHTML = "<h2 style='color:red;'>ACCESS DENIED: IDENTITY UNKNOWN</h2>"; return; }
            const d = snap.docs[0].data();
            res.innerHTML = `
                <div class="verify-header">
                    <img src="${d.photo}" class="verify-photo">
                    <div>
                        <h2 style="color:#fff">${d.name} <i class="fas fa-check-circle" style="color:#00d2ff"></i></h2>
                        <p>ID: ${d.dwID}</p><p>RANK: ${d.level}</p>
                    </div>
                </div>
                <div class="grid-layout" style="font-size: 0.9rem;">
                    <div><span style="color:#888">EMAIL:</span> ${d.email}</div>
                    <div><span style="color:#888">PHONE:</span> ${d.phone}</div>
                    <div><span style="color:#888">ADDRESS:</span> ${d.addr}</div>
                    <div><span style="color:#888">FAMILY:</span> ${d.family}</div>
                </div>
                <div style="margin-top:20px;">
                    <p style="color:#888; font-size:0.7rem; margin-bottom:5px;">SECURE NID DATA:</p>
                    <img src="${d.nid}" style="max-width:100%; border:1px solid #333; border-radius:5px;">
                </div>`;
        };

        window.switchTab = (t) => {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            document.getElementById('tab-' + t.substring(0,3)).classList.add('active');
        };
    </script>
</body>
</html>
